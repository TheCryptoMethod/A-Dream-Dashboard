<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>A_Dream Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080c14; --surface: #0f1520; --surface2: #151d2b;
  --surface3: #1a2435; --border: #1c2a3a; --border-light: #253345;
  --text: #d8e2ef; --text-sec: #8899ad; --text-dim: #506070;
  --accent: #e8870e; --accent-glow: rgba(232,135,14,.12);
  --green: #2dd4a0; --green-bg: rgba(45,212,160,.12);
  --red: #f0615e; --red-bg: rgba(240,97,94,.12);
  --yellow: #e8b53e; --yellow-bg: rgba(232,181,62,.12);
  --cyan: #38bdf8; --cyan-bg: rgba(56,189,248,.10);
  --magenta: #c77dff; --magenta-bg: rgba(199,125,255,.10);
  --mono: 'IBM Plex Mono', 'Fira Code', monospace;
  --sans: 'DM Sans', system-ui, sans-serif;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
  --bar-h: 44px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{background:var(--bg)}
body{background:var(--bg);color:var(--text);font-family:var(--sans);font-size:14px;min-height:100vh;
  padding-top:calc(var(--bar-h) + var(--safe-top));
  padding-bottom:var(--safe-bottom);
  -webkit-text-size-adjust:100%;
}

/* ‚ïê‚ïê‚ïê STICKY LIVE BAR (clickable) ‚ïê‚ïê‚ïê */
.live-bar{
  position:fixed;top:0;left:0;right:0;z-index:100;
  padding-top:var(--safe-top);
  background:linear-gradient(180deg,rgba(8,12,20,.97) 0%,rgba(8,12,20,.92) 100%);
  backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  cursor:pointer;-webkit-tap-highlight-color:transparent;
  transition:border-color .2s;
}
.live-bar:hover{border-bottom-color:var(--accent)}
.live-bar-inner{
  display:flex;align-items:center;justify-content:space-between;
  height:var(--bar-h);
  padding:0 max(1rem, var(--safe-left)) 0 max(1rem, var(--safe-right));
  max-width:1200px;margin:0 auto;
}
.lb-left{display:flex;align-items:center;gap:.6rem;min-width:0}
.lb-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.lb-dot.live{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite}
.lb-dot.dry{background:var(--yellow);animation:pulse 2s infinite}
.lb-dot.off{background:var(--text-dim)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
.lb-status{font-family:var(--mono);font-size:.75rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lb-status.live{color:var(--green)}
.lb-status.dry{color:var(--yellow)}
.lb-status.off{color:var(--text-dim)}
.lb-right{display:flex;align-items:center;gap:1rem;font-family:var(--mono);font-size:.65rem;color:var(--text-sec);flex-shrink:0}
.lb-right .val{font-weight:600;color:#fff}
.lb-right .g{color:var(--green)}.lb-right .r{color:var(--red)}
.lb-tag{font-size:.5rem;font-weight:700;letter-spacing:.05em;padding:.15rem .4rem;border-radius:3px;text-transform:uppercase}
.lb-tag.live-tag{background:var(--green-bg);color:var(--green)}
.lb-tag.dry-tag{background:var(--yellow-bg);color:var(--yellow)}

/* ‚ïê‚ïê‚ïê TERMINAL MODAL ‚ïê‚ïê‚ïê */
.modal-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;z-index:200;
  background:rgba(0,0,0,.75);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);
  opacity:0;visibility:hidden;transition:opacity .25s,visibility .25s;
}
.modal-overlay.open{opacity:1;visibility:visible}
.modal{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.95);
  z-index:201;width:min(96vw,960px);max-height:94vh;
  background:var(--surface);border:1px solid var(--border-light);
  border-radius:14px;overflow:hidden;
  display:flex;flex-direction:column;
  opacity:0;visibility:hidden;
  transition:opacity .25s,visibility .25s,transform .25s;
  box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 40px rgba(45,212,160,.04);
}
.modal-overlay.open + .modal,
.modal.open{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}

.modal.open.is-live{border-color:rgba(45,212,160,.3);box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 40px rgba(45,212,160,.08)}
.modal.open.is-dry{border-color:rgba(232,181,62,.3);box-shadow:0 20px 60px rgba(0,0,0,.5),0 0 40px rgba(232,181,62,.06)}

/* Modal Header */
.m-head{
  display:flex;align-items:center;justify-content:space-between;
  padding:.75rem 1rem;border-bottom:1px solid var(--border);
  background:var(--surface2);flex-shrink:0;
}
.m-title{font-family:var(--mono);font-size:.85rem;font-weight:700;color:#fff;display:flex;align-items:center;gap:.5rem}
.m-title .mdot{width:8px;height:8px;border-radius:50%}
.m-title .mdot.live{background:var(--green);animation:pulse 2s infinite}
.m-title .mdot.dry{background:var(--yellow);animation:pulse 2s infinite}
.m-title .mdot.off{background:var(--text-dim)}
.m-close{
  width:28px;height:28px;border-radius:6px;border:none;
  background:rgba(255,255,255,.05);color:var(--text-sec);
  font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .15s;-webkit-tap-highlight-color:transparent;
}
.m-close:hover{background:var(--red-bg);color:var(--red)}

/* Modal Stats Row */
.m-stats{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));
  gap:1px;background:var(--border);border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.ms-box{background:var(--surface);padding:.55rem .7rem}
.ms-label{font-size:.45rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text-dim);font-weight:700;margin-bottom:.15rem}
.ms-val{font-family:var(--mono);font-size:.9rem;font-weight:700}

/* Modal Bot Stats */
.m-bot-stats{
  display:flex;flex-wrap:wrap;gap:.35rem;padding:.55rem 1rem;
  border-bottom:1px solid var(--border);flex-shrink:0;
  background:rgba(0,0,0,.15);
}
.bs-pill{
  font-family:var(--mono);font-size:.6rem;font-weight:600;
  padding:.25rem .6rem;border-radius:6px;
  background:rgba(255,255,255,.04);color:var(--text-sec);
  display:flex;align-items:center;gap:.3rem;
}
.bs-pill .num{font-weight:700}
.bs-pill.hl{background:var(--green-bg);color:var(--green)}

/* Modal Terminal */
.m-terminal{
  flex:1;min-height:300px;overflow-y:auto;padding:.8rem 1rem;
  background:#040810;
  font-family:var(--mono);font-size:.72rem;line-height:1.8;
  -webkit-overflow-scrolling:touch;
}
.m-terminal::-webkit-scrollbar{width:6px}
.m-terminal::-webkit-scrollbar-track{background:transparent}
.m-terminal::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
.m-terminal .line{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding:0 .2rem;border-radius:2px}
.m-terminal .line:hover{background:rgba(255,255,255,.03)}
.m-terminal .ts{color:var(--text-dim)}
.m-terminal .emoji{margin-right:.1rem}
.m-terminal .entry{color:var(--green)}
.m-terminal .exit-win{color:var(--green)}
.m-terminal .exit-loss{color:var(--red)}
.m-terminal .migration{color:var(--cyan)}
.m-terminal .tracking{color:var(--yellow)}
.m-terminal .stats{color:var(--magenta)}
.m-terminal .system{color:var(--text-sec)}

/* Modal Footer */
.m-foot{
  display:flex;align-items:center;justify-content:space-between;
  padding:.4rem 1rem;border-top:1px solid var(--border);
  background:var(--surface2);flex-shrink:0;
  font-family:var(--mono);font-size:.55rem;color:var(--text-dim);
}

/* ‚ïê‚ïê‚ïê PAGE ‚ïê‚ïê‚ïê */
.page{max-width:1100px;margin:0 auto;padding:1.5rem max(1rem,var(--safe-left)) 4rem max(1rem,var(--safe-right))}
.top-bar{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border)}
.top-bar h1{font-family:var(--mono);font-size:1.5rem;font-weight:700;color:#fff;letter-spacing:-.02em}
.top-bar h1 span{color:var(--accent)}
.top-bar .meta{font-size:.7rem;color:var(--text-dim);font-family:var(--mono);text-align:right}
.stats-row{display:flex;gap:.75rem;margin-bottom:2rem;flex-wrap:wrap}
.stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:.65rem 1rem;min-width:110px;flex:1}
.stat-label{font-size:.55rem;text-transform:uppercase;letter-spacing:.08em;color:var(--text-dim);font-weight:600;margin-bottom:.2rem}
.stat-val{font-family:var(--mono);font-size:1.15rem;font-weight:700}
.stat-sub{font-size:.6rem;color:var(--text-dim);margin-top:.15rem}

/* ‚ïê‚ïê‚ïê SESSIONS ‚ïê‚ïê‚ïê */
.sessions-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.75rem}
.sessions-title{font-family:var(--mono);font-size:.8rem;font-weight:600;color:var(--text-sec);cursor:pointer;display:flex;align-items:center;gap:.4rem;-webkit-tap-highlight-color:transparent}
.sessions-title:hover{color:var(--text)}
.sessions-list{margin-bottom:1.5rem}
.sessions-list.hidden{display:none}
.session-row{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:.55rem .8rem;margin-bottom:.35rem;display:flex;justify-content:space-between;align-items:center;font-family:var(--mono);font-size:.62rem;gap:.5rem;flex-wrap:wrap}
.session-row .s-left{display:flex;align-items:center;gap:.6rem;min-width:0;flex-wrap:wrap}
.s-date{color:var(--text-dim);white-space:nowrap}
.s-method{color:var(--cyan);font-weight:600;white-space:nowrap}
.s-mode{font-size:.5rem;font-weight:700;letter-spacing:.04em;padding:.1rem .35rem;border-radius:3px;text-transform:uppercase}
.s-mode.live-mode{background:var(--green-bg);color:var(--green)}
.s-mode.dry-mode{background:var(--yellow-bg);color:var(--yellow)}
.s-trades{color:var(--text-sec);white-space:nowrap}
.s-pnl{font-weight:700;white-space:nowrap;flex-shrink:0}

/* ‚ïê‚ïê‚ïê METHOD CARDS ‚ïê‚ïê‚ïê */
.method-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;margin-bottom:1rem;overflow:hidden;transition:border-color .2s}
.method-card:hover{border-color:var(--border-light)}
.method-head{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.1rem}
.method-title{display:flex;align-items:center;gap:.6rem;min-width:0}
.method-title h2{font-family:var(--mono);font-size:1rem;font-weight:700;color:#fff;white-space:nowrap}
.method-title .count-badge{font-size:.55rem;font-family:var(--mono);color:var(--text-dim);background:var(--surface2);padding:.12rem .45rem;border-radius:20px}
.method-right{display:flex;align-items:center;gap:.75rem;font-family:var(--mono);font-size:.6rem;color:var(--text-dim);flex-shrink:0}
.variant-list{padding:0 1.1rem 1rem}
.variant-row{position:relative;padding:.7rem 0;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:.75rem;flex-wrap:wrap}
.variant-row:first-child{border-top:none}
.vr-left{display:flex;flex-direction:column;gap:.25rem;min-width:0;max-width:100%}
.vr-label{font-family:var(--mono);font-size:.7rem;color:var(--text-sec);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.vr-sub{font-size:.55rem;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.vr-center{display:flex;flex-wrap:wrap;gap:.3rem;align-items:center;flex:1;justify-content:flex-start}
.vr-right{display:flex;align-items:center;gap:.6rem;flex-shrink:0}
.vr-date{font-size:.55rem;color:var(--text-dim);font-family:var(--mono);white-space:nowrap}
.pill{display:inline-flex;align-items:center;font-family:var(--mono);font-size:.55rem;font-weight:600;padding:.15rem .45rem;border-radius:5px;white-space:nowrap}
.pill-green{background:var(--green-bg);color:var(--green)}
.pill-red{background:var(--red-bg);color:var(--red)}
.pill-yellow{background:var(--yellow-bg);color:var(--yellow)}
.pill-cyan{background:var(--cyan-bg);color:var(--cyan)}
.pill-magenta{background:var(--magenta-bg);color:var(--magenta)}
.pill-dim{background:rgba(255,255,255,.04);color:var(--text-dim)}
.pill-accent{background:var(--accent-glow);color:var(--accent)}
.gate-score{font-family:var(--mono);font-size:.6rem;font-weight:700;padding:.15rem .5rem;border-radius:5px}
.gate-bar{display:flex;gap:2px;align-items:center}
.gate-dot{width:5px;height:5px;border-radius:2px}
.gate-dot.pass{background:var(--green)}.gate-dot.fail{background:var(--red)}
.btn-open{font-family:var(--mono);font-size:.6rem;font-weight:600;padding:.3rem .75rem;border-radius:6px;border:1px solid var(--accent);color:var(--accent);background:transparent;cursor:pointer;transition:all .15s;white-space:nowrap;-webkit-tap-highlight-color:transparent}
.btn-open:hover,.btn-open:active{background:var(--accent);color:#000}
.btn-open.active{background:var(--accent);color:#000}
.detail-panel{max-height:0;overflow:hidden;transition:max-height .35s ease;background:var(--surface2);border-top:1px solid var(--border)}
.detail-panel.open{max-height:5000px}
.detail-inner{padding:1rem}
.d-section{margin-bottom:1rem}
.d-section-title{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--accent);margin-bottom:.4rem;display:flex;align-items:center;gap:.35rem}
.d-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:.2rem}
.kv{display:flex;justify-content:space-between;font-size:.62rem;padding:.15rem .3rem;border-radius:4px}
.kv:nth-child(odd){background:rgba(255,255,255,.015)}
.kv-l{color:var(--text-dim)}.kv-v{font-family:var(--mono);font-weight:600;color:var(--text)}
.tt-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.5rem}
.tt-box{background:rgba(255,255,255,.02);border-radius:8px;padding:.5rem .65rem;border-left:3px solid var(--border)}
.tt-box.train{border-left-color:var(--cyan)}.tt-box.test{border-left-color:var(--green)}
.tt-label{font-size:.5rem;text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-bottom:.25rem}
.overfit-strip{font-family:var(--mono);font-size:.6rem;padding:.3rem .5rem;border-radius:6px;display:inline-block}
.bar-row{display:flex;align-items:center;gap:.25rem;font-size:.55rem;font-family:var(--mono);margin:.12rem 0}
.bar-label{width:80px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bar-bg{flex:1;height:7px;background:rgba(255,255,255,.04);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px}.bar-fill.good{background:var(--green)}.bar-fill.bad{background:var(--red)}
.bar-val{width:30px;text-align:right}.bar-n{width:26px;color:var(--text-dim);text-align:right}
.env-wrap{position:relative;margin-top:.5rem}
.env-block{background:#070b12;border:1px solid var(--border);border-radius:8px;padding:.7rem .8rem;font-family:var(--mono);font-size:.55rem;line-height:1.6;white-space:pre-wrap;word-break:break-all;color:var(--text-sec);max-height:280px;overflow-y:auto;-webkit-overflow-scrolling:touch}
.env-block .c{color:var(--text-dim)}
.btn-copy{position:absolute;top:.35rem;right:.35rem;background:var(--surface3);border:1px solid var(--border);border-radius:5px;color:var(--text-dim);font-family:var(--mono);font-size:.55rem;padding:.15rem .5rem;cursor:pointer;-webkit-tap-highlight-color:transparent}
.btn-copy:hover,.btn-copy:active{color:var(--accent);border-color:var(--accent)}
.hist-row{display:flex;gap:.75rem;font-size:.55rem;font-family:var(--mono);color:var(--text-dim);padding:.12rem 0;flex-wrap:wrap}
.hist-row span:first-child{min-width:95px}
.empty{text-align:center;padding:3rem 1.5rem;color:var(--text-dim)}
.empty h3{font-family:var(--mono);color:var(--text-sec);margin-bottom:.4rem}

/* ‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê */
@media(max-width:768px){
  .m-stats{grid-template-columns:repeat(3,1fr)}
  .method-head{flex-direction:column;align-items:flex-start;gap:.4rem}
  .method-right{width:100%;justify-content:flex-end}
}
@media(max-width:520px){
  :root{--bar-h:38px}
  body{font-size:13px}
  .page{padding:1rem max(.75rem,var(--safe-left)) 3rem max(.75rem,var(--safe-right))}
  .top-bar{flex-direction:column;align-items:flex-start;gap:.3rem}
  .top-bar .meta{text-align:left}
  .stats-row{gap:.4rem}
  .stat{min-width:0;padding:.5rem .7rem}
  .stat-val{font-size:.95rem}
  .live-bar-inner{padding:0 max(.75rem,var(--safe-left)) 0 max(.75rem,var(--safe-right))}
  .lb-status{font-size:.65rem}
  .lb-right{gap:.5rem;font-size:.55rem}
  .lb-right .hide-m{display:none}
  .modal{width:100vw;max-height:100vh;border-radius:0;top:50%;left:50%;transform:translate(-50%,-50%) scale(.95)}
  .modal.open{transform:translate(-50%,-50%) scale(1)}
  .m-stats{grid-template-columns:repeat(2,1fr)}
  .m-terminal{font-size:.62rem;min-height:200px}
  .m-head{padding:.6rem .8rem}
  .ms-val{font-size:.7rem}
  .variant-row{flex-direction:column;align-items:flex-start;gap:.35rem}
  .vr-center{padding-left:0}
  .vr-right{width:100%;justify-content:space-between}
  .tt-grid{grid-template-columns:1fr}
  .d-grid{grid-template-columns:1fr 1fr}
  .detail-inner{padding:.75rem}
  .session-row{flex-direction:column;align-items:flex-start;gap:.3rem}
  .session-row .s-pnl{width:100%;text-align:right}
}
@supports(padding-top:env(safe-area-inset-top)){
  .live-bar{padding-top:env(safe-area-inset-top)}
  body{padding-top:calc(var(--bar-h) + env(safe-area-inset-top))}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê STICKY BAR ‚ïê‚ïê‚ïê -->
<div class="live-bar" id="live-bar" onclick="openTerminal()">
  <div class="live-bar-inner">
    <div class="lb-left">
      <div class="lb-dot off" id="lb-dot"></div>
      <div class="lb-status off" id="lb-status">Offline</div>
    </div>
    <div class="lb-right" id="lb-right"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TERMINAL MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="modal-overlay" onclick="closeTerminal()"></div>
<div class="modal" id="modal">
  <div class="m-head">
    <div class="m-title">
      <div class="mdot off" id="m-dot"></div>
      <span id="m-title-text">Bot Terminal</span>
    </div>
    <button class="m-close" onclick="closeTerminal()">‚úï</button>
  </div>
  <div class="m-stats" id="m-stats"></div>
  <div class="m-bot-stats" id="m-bot-stats"></div>
  <div class="m-terminal" id="m-terminal">
    <div style="color:var(--text-dim);padding:2rem;text-align:center">Bot ist nicht aktiv.</div>
  </div>
  <div class="m-foot">
    <span id="m-foot-left">‚Äî</span>
    <span id="m-foot-right">‚Äî</span>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PAGE (Backtesting) ‚ïê‚ïê‚ïê -->
<div class="page">
  <div class="top-bar">
    <div><h1>A<span>_</span>Dream</h1><div style="font-size:.7rem;color:var(--text-dim);margin-top:.15rem">Trading Dashboard</div></div>
    <div class="meta"><div id="last-update">‚Äî</div><div style="margin-top:.15rem;font-size:.6rem;opacity:.5">auto-refresh 60s</div></div>
  </div>
  <div class="stats-row" id="stats"></div>
  <div id="sessions-section"></div>
  <div id="root"></div>
</div>

<script>
const $=id=>document.getElementById(id);
const sp=(v,d=2)=>v==null?'‚Äî':`${v>=0?'+':''}${v.toFixed(d)}%`;
const pf=v=>v==null?'‚Äî':(v*100).toFixed(1)+'%';
const kv=(k,v)=>`<div class="kv"><span class="kv-l">${k}</span><span class="kv-v">${v}</span></div>`;
function pillFor(l,v,t){let c='pill-dim';if(t)for(const x of t)if(v>=x.min){c=x.cls;break}return`<span class="pill ${c}">${l}</span>`}
function gateScorePill(g,a){if(a)return`<span class="gate-score pill-green">‚úÖ 11/11</span>`;if(g>=9)return`<span class="gate-score pill-yellow">‚ö† ${g}/11</span>`;return`<span class="gate-score pill-accent">${g}/11</span>`}
function gateDots(g){if(!g)return'';const o=['SIG','EQ','WF','MC','PLT','REG','ROB','tT','DSR','WRC','HHI'];return`<div class="gate-bar" title="${o.map(x=>x+'='+(g[x]?'‚úì':'‚úó')).join('  ')}">${o.map(x=>`<div class="gate-dot ${g[x]?'pass':'fail'}"></div>`).join('')}</div>`}
function fmtDur(s){if(!s)return'‚Äî';const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=Math.floor(s%60);return h>0?`${h}h ${m}m`:m>0?`${m}m ${sc}s`:`${sc}s`}
function fmtPnl(v){return v==null?'‚Äî':`${v>=0?'+':''}${v.toFixed(4)}`}
function pC(v){return v>=0?'g':'r'}

let liveData=null,modalOpen=false,sessionsVisible=true;

/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
function openTerminal(){
  modalOpen=true;
  $('modal-overlay').classList.add('open');
  const modal=$('modal');
  modal.classList.add('open');
  // Add mode class for glow
  modal.classList.remove('is-live','is-dry');
  if(liveData&&liveData.status==='live'){
    modal.classList.add(liveData.dry_run?'is-dry':'is-live');
  }
  renderModal(liveData);
}
function closeTerminal(){
  modalOpen=false;
  $('modal-overlay').classList.remove('open');
  $('modal').classList.remove('open');
}

/* ‚ïê‚ïê‚ïê COLORIZE TERMINAL LINE ‚ïê‚ïê‚ïê */
function colorLine(raw){
  const m=raw.match(/^\[(\d{2}:\d{2}:\d{2})\]\s*(.*)/);
  if(!m) return `<div class="line system">${raw}</div>`;
  const ts=m[1],body=m[2];
  let cls='system';
  if(body.includes('üü¢ ENTRY')||body.includes('üí∞ Position filled')) cls='entry';
  else if(body.includes('üü¢ Take Profit')||body.includes('üü¢ Trailing')) cls='exit-win';
  else if(body.includes('üî¥ Stop Loss')||body.includes('üî¥ Early Exit')||body.includes('üî¥ Timeout')) cls='exit-loss';
  else if(body.includes('üîî')||body.includes('Migration')) cls='migration';
  else if(body.includes('‚úÖ BC Graduated')) cls='migration';
  else if(body.includes('üì°')||body.includes('Tracking')) cls='tracking';
  else if(body.includes('üìä')) cls='stats';
  else if(body.includes('‚ùå')||body.includes('üö´')||body.includes('‚ö†Ô∏è')||body.includes('üíß')) cls='exit-loss';
  return `<div class="line ${cls}"><span class="ts">${ts}</span> ${body}</div>`;
}

/* ‚ïê‚ïê‚ïê BAR UPDATE ‚ïê‚ïê‚ïê */
function updateBar(d){
  const dot=$('lb-dot'),st=$('lb-status'),rt=$('lb-right');
  if(!d||d.status!=='live'){
    dot.className='lb-dot off';st.className='lb-status off';
    st.textContent='Trader Offline';
    rt.innerHTML='';return;
  }
  const dry=d.dry_run,mode=dry?'dry':'live';
  dot.className='lb-dot '+mode;st.className='lb-status '+mode;
  st.textContent=(dry?'üß™ Simulation':'üî¥ LIVE')+' ‚Äî '+(d.method||'?');
  const b=d.balance||{},t=d.trades||{};
  rt.innerHTML=`<span class="lb-tag ${dry?'dry-tag':'live-tag'}">${dry?'DRY RUN':'LIVE'}</span>`
    +`<span class="hide-m">‚è± ${fmtDur(d.uptime_seconds)}</span>`
    +`<span><span class="g">${t.wins||0}W</span>/<span class="r">${t.losses||0}L</span></span>`
    +`<span class="${pC(b.pnl_sol)} val">${fmtPnl(b.pnl_sol)} SOL</span>`;
}

/* ‚ïê‚ïê‚ïê MODAL RENDER ‚ïê‚ïê‚ïê */
function renderModal(d){
  const mDot=$('m-dot'),mTitle=$('m-title-text'),mStats=$('m-stats'),
        mBotStats=$('m-bot-stats'),mTerm=$('m-terminal'),
        mFootL=$('m-foot-left'),mFootR=$('m-foot-right');
  
  if(!d||d.status!=='live'){
    mDot.className='mdot off';mTitle.textContent='Bot Terminal ‚Äî Offline';
    mStats.innerHTML='';mBotStats.innerHTML='';
    let offMsg='<div style="color:var(--text-dim);padding:3rem;text-align:center;font-size:.8rem">'
      +'<div style="font-size:2rem;margin-bottom:.5rem">‚è∏</div>'
      +'Bot ist offline.';
    if(d&&d.last_session) offMsg+=`<br><br><div style="background:var(--surface2);border-radius:8px;padding:.8rem;display:inline-block;text-align:left"><span style="color:var(--cyan)">${d.last_session.method||'?'}</span> ¬∑ ${d.last_session.duration_formatted||'?'}<br><span style="color:var(--${(d.last_session.pnl_sol||0)>=0?'green':'red'})">${fmtPnl(d.last_session.pnl_sol)} SOL</span> ¬∑ ${d.last_session.total_trades||0} Trades (${d.last_session.wins||0}W/${d.last_session.losses||0}L)</div>`;
    offMsg+='</div>';
    mTerm.innerHTML=offMsg;
    mFootL.textContent='‚Äî';mFootR.textContent='‚Äî';
    return;
  }
  
  const dry=d.dry_run,mode=dry?'dry':'live',
        b=d.balance||{},t=d.trades||{},pos=d.positions||{},
        bs=d.bot_stats||{},sol=d.sol_price||0;
  
  mDot.className='mdot '+mode;
  mTitle.textContent=(dry?'üß™ Simulation':'üî¥ LIVE')+' ‚Äî '+(d.method||'?');
  
  // Stats row
  mStats.innerHTML=
    `<div class="ms-box"><div class="ms-label">Method</div><div class="ms-val" style="color:var(--cyan)">${d.method||'‚Äî'}</div></div>`
    +`<div class="ms-box"><div class="ms-label">PnL</div><div class="ms-val" style="color:var(--${b.pnl_sol>=0?'green':'red'})">${fmtPnl(b.pnl_sol)} SOL</div></div>`
    +`<div class="ms-box"><div class="ms-label">Balance</div><div class="ms-val">${b.current!=null?b.current.toFixed(4):'‚Äî'}</div></div>`
    +`<div class="ms-box"><div class="ms-label">Trades</div><div class="ms-val">${t.total||0} <span style="font-size:.65rem"><span style="color:var(--green)">${t.wins||0}W</span> / <span style="color:var(--red)">${t.losses||0}L</span></span></div></div>`
    +`<div class="ms-box"><div class="ms-label">Win Rate</div><div class="ms-val" style="color:${(t.win_rate||0)>=50?'var(--green)':'var(--red)'}">${t.win_rate||0}%</div></div>`
    +`<div class="ms-box"><div class="ms-label">Uptime</div><div class="ms-val">${fmtDur(d.uptime_seconds)}</div></div>`;
  
  // Bot stats pills
  let bsHtml='';
  if(sol>0) bsHtml+=`<div class="bs-pill">SOL <span class="num">$${sol.toFixed(2)}</span></div>`;
  if(bs.migrations_seen>0) bsHtml+=`<div class="bs-pill hl">Migrations <span class="num">${bs.migrations_seen}</span></div>`;
  if(bs.bc_graduated>0) bsHtml+=`<div class="bs-pill" style="color:var(--cyan)">BC Grad <span class="num">${bs.bc_graduated}</span></div>`;
  bsHtml+=`<div class="bs-pill">Tracking <span class="num">${bs.pools_tracking||0}</span></div>`;
  bsHtml+=`<div class="bs-pill">Updates <span class="num">${(bs.price_updates||0).toLocaleString()}</span></div>`;
  if(bs.entries_found>0) bsHtml+=`<div class="bs-pill" style="background:var(--green-bg);color:var(--green)">Entries <span class="num">${bs.entries_found}</span></div>`;
  if(bs.buys_success>0) bsHtml+=`<div class="bs-pill" style="background:var(--green-bg);color:var(--green)">Filled <span class="num">${bs.buys_success}</span></div>`;
  if(bs.buys_failed>0) bsHtml+=`<div class="bs-pill" style="color:var(--red)">Buy Fail <span class="num">${bs.buys_failed}</span></div>`;
  if(bs.migrations_rejected>0) bsHtml+=`<div class="bs-pill" style="color:var(--yellow)">Rejected <span class="num">${bs.migrations_rejected}</span></div>`;
  if(bs.liquidity_rejected>0) bsHtml+=`<div class="bs-pill" style="color:var(--yellow)">Liq Rej <span class="num">${bs.liquidity_rejected}</span></div>`;
  mBotStats.innerHTML=bsHtml;
  
  // Terminal lines
  const lines=(d.terminal||[]).map(colorLine).join('');
  mTerm.innerHTML=lines||'<div style="color:var(--text-dim);padding:1rem">Waiting for logs...</div>';
  mTerm.scrollTop=mTerm.scrollHeight;
  
  // Footer
  const updatedAt=d.updated_at?new Date(d.updated_at).toLocaleTimeString('de-DE'):'‚Äî';
  mFootL.textContent=`${d.method||'?'} ¬∑ ${dry?'Simulation':'LIVE'}`;
  mFootR.textContent=`Updated: ${updatedAt}`;
}

/* ‚ïê‚ïê‚ïê LIVE POLL ‚ïê‚ïê‚ïê */
function isStale(d){
  if(!d||!d.updated_at) return true;
  const updated=new Date(d.updated_at).getTime();
  const now=Date.now();
  return (now - updated) > 150000; // 2.5 minutes = stale
}

function renderLive(d){
  // If data is stale, treat as offline
  if(d && d.status==='live' && isStale(d)){
    d={...d, status:'offline', _was_stale:true};
  }
  liveData=d;
  updateBar(d);
  if(modalOpen) renderModal(d);
}

function renderSessions(sessions){
  const sec=$('sessions-section');if(!sessions||!sessions.length){sec.innerHTML='';return}
  const sorted=[...sessions].reverse(),liveN=sorted.filter(s=>!s.dry_run).length,simN=sorted.length-liveN;
  const rows=sorted.slice(0,30).map(ss=>{const pc=pC(ss.pnl_sol),dt=ss.started_at?ss.started_at.substring(0,16).replace('T',' '):'‚Äî',dry=ss.dry_run;
    return`<div class="session-row"${dry?' style="opacity:.6"':''}><div class="s-left"><span class="s-date">${dt}</span><span class="s-mode ${dry?'dry-mode':'live-mode'}">${dry?'SIM':'LIVE'}</span><span class="s-method">${ss.method||'?'}</span><span class="s-trades">${ss.total_trades||0}T (${ss.wins||0}W/${ss.losses||0}L) ¬∑ ${ss.duration_formatted||'‚Äî'}</span></div><span class="s-pnl ${pc}">${fmtPnl(ss.pnl_sol)} SOL${ss.pnl_pct!=null?' ('+sp(ss.pnl_pct,1)+')':''}</span></div>`}).join('');
  sec.innerHTML=`<div class="sessions-header"><div class="sessions-title" onclick="sessionsVisible=!sessionsVisible;document.querySelector('.sessions-list').classList.toggle('hidden')">üìã Sessions (${liveN} Live${simN?', '+simN+' Sim':''}) ${sessionsVisible?'‚ñ≤':'‚ñº'}</div></div><div class="sessions-list${sessionsVisible?'':' hidden'}">${rows}</div>`;
}

async function loadData(){try{const r=await fetch('data/results.json?t='+Date.now());return await r.json()}catch(e){return null}}
function renderStats(data){
  const ms=data.methods||{},mns=Object.keys(ms);let tv=0,val=0,bestS=null,bestEV=null;
  mns.forEach(mn=>{ms[mn].forEach(v=>{tv++;const c=v.current||{},m=c.metrics||{};if(c.all_11_passed)val++;if(m.sortino!=null&&(!bestS||m.sortino>bestS.v))bestS={v:m.sortino,l:mn};if(m.avg_pnl!=null&&(!bestEV||m.avg_pnl>bestEV.v))bestEV={v:m.avg_pnl,l:mn}})});
  $('stats').innerHTML=`<div class="stat"><div class="stat-label">Methods</div><div class="stat-val" style="color:var(--cyan)">${mns.length}</div><div class="stat-sub">${tv} variants</div></div><div class="stat"><div class="stat-label">Validated</div><div class="stat-val" style="color:${val?'var(--green)':'var(--red)'}">${val}</div><div class="stat-sub">11/11 gates</div></div><div class="stat"><div class="stat-label">Best Sortino</div><div class="stat-val" style="color:var(--cyan)">${bestS?bestS.v.toFixed(2):'‚Äî'}</div><div class="stat-sub">${bestS?bestS.l:'‚Äî'}</div></div><div class="stat"><div class="stat-label">Best EV</div><div class="stat-val" style="color:var(--green)">${bestEV?sp(bestEV.v):'‚Äî'}</div><div class="stat-sub">${bestEV?bestEV.l:'‚Äî'}</div></div>`;
}
function renderAll(data){
  const ms=data.methods||{},root=$('root');root.innerHTML='';const sorted=Object.keys(ms).sort();
  if(!sorted.length){root.innerHTML='<div class="empty"><h3>Keine Ergebnisse</h3><p>Starte einen Backtest.</p></div>';return}
  sorted.forEach(mn=>{
    const variants=ms[mn];let bestGP=0;variants.forEach(v=>{const gp=v.current?.gates_passed||0;if(gp>bestGP)bestGP=gp});
    const lastDate=variants[0]?.updated_at?.substring(0,10)||'‚Äî',totalRuns=variants.reduce((s,v)=>s+(v.run_count||1),0);
    const card=document.createElement('div');card.className='method-card';
    card.innerHTML=`<div class="method-head"><div class="method-title"><h2>${mn}</h2>${gateScorePill(bestGP,variants.some(v=>v.current?.all_11_passed))}<span class="count-badge">${variants.length} Variant${variants.length!==1?'en':''}</span></div><div class="method-right"><span>${totalRuns} Tests</span><span>¬∑</span><span>${lastDate}</span></div></div><div class="variant-list" id="vlist-${mn}"></div>`;
    root.appendChild(card);const vlist=document.getElementById('vlist-'+mn);
    variants.forEach((v,i)=>{
      const cur=v.current||{},met=cur.metrics||{},gp=cur.gates_passed||0,rm=cur._run_meta||{},uid=mn+'-'+i;
      const row=document.createElement('div');
      row.innerHTML=`<div class="variant-row"><div class="vr-left"><div class="vr-label">${v.db_name||'‚Äî'}</div><div class="vr-sub">${v.flags||'‚Äî'} ¬∑ ${rm.time_span||'?'} ¬∑ ${rm.unique_mints||'?'} mints</div></div><div class="vr-center">${gateScorePill(gp,cur.all_11_passed)} ${pillFor(pf(met.win_rate),met.win_rate,[{min:.4,cls:'pill-green'},{min:.3,cls:'pill-yellow'},{min:0,cls:'pill-red'}])} ${pillFor(sp(met.avg_pnl,1),(met.avg_pnl||0),[{min:0.5,cls:'pill-green'},{min:0,cls:'pill-yellow'},{min:-999,cls:'pill-red'}])} ${pillFor('Srt '+(met.sortino||0).toFixed(1),(met.sortino||0),[{min:1,cls:'pill-cyan'},{min:.5,cls:'pill-yellow'},{min:0,cls:'pill-dim'}])} ${met.n_trades?`<span class="pill pill-dim">${met.n_trades}T</span>`:''} ${gateDots(cur.gates)}</div><div class="vr-right"><span class="vr-date">${(v.updated_at||'').substring(0,16).replace('T',' ')}</span><button class="btn-open" onclick="toggleDetail('${uid}',this)">√ñffnen</button></div></div><div class="detail-panel" id="dp-${uid}"><div class="detail-inner">${renderDetail(cur,v)}</div></div>`;
      vlist.appendChild(row);
    });
  });
}
function toggleDetail(u,b){const p=document.getElementById('dp-'+u),o=p.classList.contains('open');p.classList.toggle('open');b.classList.toggle('active');b.textContent=o?'√ñffnen':'Schlie√üen'}
function renderDetail(cur,variant){
  if(!cur||!cur.metrics)return'<div style="color:var(--text-dim)">Keine Daten</div>';
  const met=cur.metrics||{},tt=cur.train_test||{},gates=cur.gates||{},gv=cur.gate_values||{},cfg=cur.config||{},envBlock=cur.env_block||'';
  const euid='e'+Math.random().toString(36).substr(2,6);let html='';
  html+=`<div class="d-section"><div class="d-section-title">üìä Performance (TEST)</div><div class="d-grid">${kv('Trades',met.n_trades||0)}${kv('Win Rate',pf(met.win_rate))}${kv('EV/Trade',sp(met.avg_pnl,3))}${kv('Total PnL',sp(met.total_pnl,1))}${kv('PF',(met.profit_factor||0).toFixed(3))}${kv('Sortino',(met.sortino||0).toFixed(3))}${kv('Sharpe',(met.sharpe||0).toFixed(3))}${kv('Max DD',(met.max_dd||0).toFixed(1)+'%')}${kv('RoR',(met.risk_of_ruin||0).toFixed(1)+'%')}${met.n_early_exits>0?kv('Early Exits',met.n_early_exits):''}${kv('SL/TP',(cfg.sl_pct||'?')+'%/'+(cfg.tp_pct||'?')+'%')}${cfg.has_trailing?kv('Trail','A='+cfg.trailing_activation_pct+'% T='+cfg.trailing_pct+'%'):''}</div></div>`;
  const go=['SIG','EQ','WF','MC','PLT','REG','ROB','tT','DSR','WRC','HHI'];
  html+=`<div class="d-section"><div class="d-section-title">üîí 11-Gate Validation</div><div style="display:flex;flex-wrap:wrap;gap:.25rem">${go.map(g=>`<span class="pill ${gates[g]?'pill-green':'pill-red'}" title="${gv[g]||''}">${g}${gv[g]?' ¬∑ '+gv[g]:''}</span>`).join('')}</div></div>`;
  if(tt&&tt.train_n){const deg=tt.train_avg_pnl>0?(1-tt.test_avg_pnl/tt.train_avg_pnl):0,dp=Math.round(deg*100);let dc='var(--green)',dl='Consistent';if(deg>.5){dc='var(--red)';dl='OVERFIT ‚ö†'}else if(deg>.25){dc='var(--yellow)';dl='Moderate ‚ö†'}
    html+=`<div class="d-section"><div class="d-section-title">üîÄ Train / Test</div><div class="tt-grid"><div class="tt-box train"><div class="tt-label" style="color:var(--cyan)">Train</div>${kv('n',tt.train_n)}${kv('EV',sp(tt.train_avg_pnl,3))}${kv('WR',pf(tt.train_win_rate))}${tt.train_period?`<div style="font-size:.5rem;color:var(--text-dim);margin-top:.1rem">${tt.train_period}</div>`:''}</div><div class="tt-box test"><div class="tt-label" style="color:var(--green)">Test</div>${kv('n',tt.test_n)}${kv('EV',sp(tt.test_avg_pnl,3))}${kv('WR',pf(tt.test_win_rate))}${tt.test_period?`<div style="font-size:.5rem;color:var(--text-dim);margin-top:.1rem">${tt.test_period}</div>`:''}</div></div><span class="overfit-strip" style="background:${deg>.25?'var(--red-bg)':'var(--green-bg)'};color:${dc}">${dl} ¬∑ ${dp>0?'-':'+'}${Math.abs(dp)}%</span></div>`}
  html+=renderLift(cur.lift_filters);html+=renderPost(cur.post_entry_filters);
  if(envBlock){const hl=envBlock.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/(#[^\n]*)/g,'<span class="c">$1</span>');html+=`<div class="d-section"><div class="d-section-title">‚öôÔ∏è .env</div><div class="env-wrap"><button class="btn-copy" onclick="copyEnv('${euid}')">üìã Copy</button><div class="env-block" id="${euid}">${hl}</div></div></div>`}
  html+=`<div class="d-section"><div class="d-grid">${kv('Raw',cur.n_total_entries||0)}${kv('Filtered',cur.n_filtered_entries||0)}${cur.n_total_entries>0?kv('Removed',((1-(cur.n_filtered_entries||0)/cur.n_total_entries)*100).toFixed(1)+'%'):''}</div></div>`;
  const hist=variant.history||[];if(hist.length){html+=`<div class="d-section"><div class="d-section-title">üìú History (${hist.length})</div>${hist.map(h=>`<div class="hist-row"><span>${(h.timestamp||'?').substring(0,16)}</span><span style="color:${h.gates_passed>=11?'var(--green)':h.gates_passed>=9?'var(--yellow)':'var(--text-dim)'};">${h.gates_passed}/11</span><span style="color:${(h.avg_pnl||0)>=0?'var(--green)':'var(--red)'};">${sp(h.avg_pnl,3)}</span><span>Srt=${(h.sortino||0).toFixed(2)}</span><span>n=${h.n_trades||'?'}</span></div>`).join('')}</div>`}
  return html;
}
function renderLift(lift){
  if(!lift)return'';const dims=[{key:'mcap',label:'MCAP'},{key:'time',label:'Time‚ÜíEntry'},{key:'dd',label:'DD@Entry'},{key:'hour',label:'Hour(UTC)'}];let has=false;dims.forEach(d=>{if(lift[d.key]&&Object.keys(lift[d.key]).length)has=true});if(!has)return'';
  let html=`<div class="d-section"><div class="d-section-title">üìà Pre-Entry LIFT</div>`;
  dims.forEach(d=>{const data=lift[d.key];if(!data||!Object.keys(data).length)return;html+=`<div style="font-size:.55rem;color:var(--cyan);font-weight:600;margin:.3rem 0 .1rem">${d.label}</div>`;Object.entries(data).forEach(([k,v])=>{const w=Math.min(100,(v.lift||0)*40);html+=`<div class="bar-row"><span class="bar-label">${k}</span><div class="bar-bg"><div class="bar-fill ${v.good?'good':'bad'}" style="width:${w}%"></div></div><span class="bar-val" style="color:${v.good?'var(--green)':'var(--red)'};">${(v.lift||0).toFixed(2)}</span><span class="bar-n">n=${v.count||0}</span></div>`})});
  return html+'</div>';
}
function renderPost(pf2){
  if(!pf2||!Object.keys(pf2).length)return'';let has=false;Object.values(pf2).forEach(bs=>{Object.values(bs).forEach(b=>{if(!b.keep)has=true})});if(!has)return'';
  let html=`<div class="d-section"><div class="d-section-title">üîç Post-Entry Filter</div>`;
  Object.entries(pf2).forEach(([cat,buckets])=>{const exits=Object.entries(buckets).filter(([,b])=>!b.keep);if(!exits.length)return;html+=`<div style="font-size:.55rem;color:var(--magenta);font-weight:600;margin:.3rem 0 .1rem">${cat}</div>`;Object.entries(buckets).forEach(([s,b])=>{const w=Math.min(100,(b.lift||0)*40);html+=`<div class="bar-row"><span class="bar-label" style="width:90px">${s}</span><div class="bar-bg"><div class="bar-fill ${b.keep?'good':'bad'}" style="width:${w}%"></div></div><span style="width:26px;text-align:center;font-weight:700;font-size:.5rem;color:${b.keep?'var(--green)':'var(--red)'};">${b.keep?'OK':'EXIT'}</span><span class="bar-val" style="color:${b.keep?'var(--green)':'var(--red)'};">${(b.lift||0).toFixed(2)}</span><span class="bar-n">n=${b.count||0}</span></div>`})});
  return html+'</div>';
}
function copyEnv(uid){const el=document.getElementById(uid);if(!el)return;navigator.clipboard.writeText(el.innerText.trim()).then(()=>{const b=el.parentElement.querySelector('.btn-copy');if(b){b.textContent='‚úÖ';setTimeout(()=>b.textContent='üìã Copy',1500)}})}

/* ‚ïê‚ïê‚ïê POLLING ‚ïê‚ïê‚ïê */
async function pollLive(){try{const r=await fetch('data/live_status.json?t='+Date.now(),{signal:AbortSignal.timeout(4000)});if(r.ok)renderLive(await r.json());else renderLive(null)}catch(e){renderLive(null)}}
async function pollSessions(){try{const r=await fetch('data/sessions.json?t='+Date.now(),{signal:AbortSignal.timeout(5000)});if(r.ok)renderSessions(await r.json());else renderSessions([])}catch(e){renderSessions([])}}
async function initBT(){const d=await loadData();if(!d){$('root').innerHTML='<div class="empty"><h3>Fehler</h3><p>results.json nicht geladen.</p></div>';return}$('last-update').textContent='Letzter: '+(d.last_updated?new Date(d.last_updated).toLocaleString('de-DE'):'‚Äî');renderStats(d);renderAll(d)}

pollLive();pollSessions();initBT();
setInterval(pollLive,30000);setInterval(pollSessions,60000);setInterval(initBT,60000);

// ESC to close modal
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&modalOpen)closeTerminal()});
</script>
</body>
</html>
