<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>A_Dream Dashboard V3</title>
<style>
:root {
  --bg: #0a0e17; --surface: #111827; --surface2: #1a2332;
  --border: #1e2d3d; --text: #e0e7ef; --text-secondary: #94a3b8;
  --text-muted: #64748b; --green: #22c55e; --red: #ef4444;
  --yellow: #eab308; --cyan: #06b6d4; --magenta: #d946ef;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
  --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: var(--bg); color: var(--text); font-family: var(--font-sans); font-size: 14px; padding: 1rem; }
h1 { font-size: 1.3rem; color: var(--cyan); margin-bottom: .5rem; }
.header { display: flex; justify-content: space-between; align-items: center; padding: .75rem 1rem; background: var(--surface); border-radius: 8px; margin-bottom: 1rem; border: 1px solid var(--border); }
.header-sub { font-size: .7rem; color: var(--text-muted); }

/* Summary cards */
.summary { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: .5rem; margin-bottom: 1rem; }
.summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: .75rem; text-align: center; }
.summary-label { font-size: .6rem; text-transform: uppercase; color: var(--text-muted); letter-spacing: .05em; }
.summary-value { font-size: 1.4rem; font-weight: 700; font-family: var(--font-mono); margin: .25rem 0; }
.summary-sub { font-size: .6rem; color: var(--text-secondary); }

/* Method folder */
.method-folder { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: .75rem; overflow: hidden; }
.method-header { display: flex; align-items: center; justify-content: space-between; padding: .75rem 1rem; cursor: pointer; user-select: none; transition: background .15s; }
.method-header:hover { background: var(--surface2); }
.method-name { font-size: 1rem; font-weight: 700; color: var(--cyan); font-family: var(--font-mono); }
.method-badge { font-size: .65rem; padding: .15rem .5rem; border-radius: 4px; font-weight: 600; font-family: var(--font-mono); }
.method-badge.validated { background: rgba(34,197,94,.15); color: var(--green); }
.method-badge.partial { background: rgba(234,179,8,.15); color: var(--yellow); }
.method-badge.none { background: rgba(239,68,68,.15); color: var(--red); }
.method-body { display: none; padding: 0 1rem 1rem; }
.method-body.open { display: block; }
.chevron { font-size: .8rem; color: var(--text-muted); transition: transform .2s; }
.chevron.open { transform: rotate(90deg); }

/* Variant row */
.variant { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; margin-bottom: .5rem; overflow: hidden; }
.variant-header { display: flex; align-items: center; justify-content: space-between; padding: .5rem .75rem; cursor: pointer; font-size: .75rem; }
.variant-header:hover { background: rgba(6,182,212,.05); }
.variant-tag { font-family: var(--font-mono); color: var(--text-secondary); font-size: .65rem; }
.variant-stats { font-family: var(--font-mono); font-size: .65rem; display: flex; gap: .75rem; align-items: center; }
.variant-detail { display: none; padding: .75rem; border-top: 1px solid var(--border); }
.variant-detail.open { display: block; }

/* Gate pills */
.gate-pill { display: inline-block; font-size: .55rem; font-family: var(--font-mono); padding: .1rem .3rem; border-radius: 3px; margin-right: 2px; font-weight: 600; }
.gate-pill.pass { background: rgba(34,197,94,.15); color: var(--green); }
.gate-pill.fail { background: rgba(239,68,68,.15); color: var(--red); }

/* Detail grid */
.detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: .3rem; }
.kv { display: flex; justify-content: space-between; font-size: .7rem; padding: .15rem .3rem; border-radius: 3px; }
.kv:nth-child(odd) { background: rgba(255,255,255,.02); }
.kv-label { color: var(--text-muted); }
.kv-value { font-family: var(--font-mono); font-weight: 600; }

/* Train/Test */
.train-test { display: grid; grid-template-columns: 1fr 1fr; gap: .5rem; margin: .5rem 0; }
.tt-panel { background: rgba(255,255,255,.03); border-radius: 6px; padding: .5rem; }
.tt-title { font-size: .55rem; text-transform: uppercase; font-weight: 700; margin-bottom: .25rem; letter-spacing: .05em; }
.overfit-bar { font-family: var(--font-mono); font-size: .65rem; padding: .3rem .5rem; border-radius: 4px; margin-top: .3rem; }

/* LIFT + Post-Entry bars */
.filter-section { margin-top: .75rem; }
.filter-title { font-size: .7rem; font-weight: 700; margin-bottom: .3rem; }
.filter-cat { font-size: .6rem; color: var(--cyan); font-weight: 600; margin: .5rem 0 .2rem; }
.bar-row { display: flex; align-items: center; gap: .3rem; font-size: .6rem; font-family: var(--font-mono); margin: .1rem 0; }
.bar-label { width: 80px; color: var(--text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.bar-bg { flex: 1; height: 10px; background: rgba(255,255,255,.05); border-radius: 5px; overflow: hidden; }
.bar-fill { height: 100%; border-radius: 5px; }
.bar-fill.good { background: var(--green); }
.bar-fill.bad { background: var(--red); }
.bar-val { width: 35px; text-align: right; }
.bar-tag { width: 30px; text-align: center; font-weight: 700; font-size: .55rem; }

/* .env block */
.env-block { background: #0d1117; border: 1px solid var(--border); border-radius: 6px; padding: .75rem; font-family: var(--font-mono); font-size: .6rem; line-height: 1.5; white-space: pre-wrap; word-break: break-all; color: var(--text-secondary); position: relative; margin-top: .5rem; }
.env-block .comment { color: var(--text-muted); }
.copy-btn { position: absolute; top: .3rem; right: .3rem; background: var(--surface2); border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); font-size: .6rem; padding: .2rem .5rem; cursor: pointer; }
.copy-btn:hover { color: var(--cyan); border-color: var(--cyan); }

/* History */
.history { margin-top: .5rem; }
.history-row { display: flex; gap: .75rem; font-size: .6rem; font-family: var(--font-mono); color: var(--text-muted); padding: .15rem 0; }

/* Grade */
.grade { font-weight: 700; font-family: var(--font-mono); font-size: .7rem; }
.grade-a { color: var(--green); }
.grade-b { color: var(--yellow); }
.grade-c { color: var(--red); }
</style>
</head>
<body>
<div class="header">
  <div>
    <h1>üöÄ A_Dream Dashboard</h1>
    <div class="header-sub">V3 Hierarchical ‚Äî <span id="last-update">loading...</span></div>
  </div>
  <div style="font-size:.65rem;color:var(--text-muted)" id="auto-refresh">Auto-refresh: 60s</div>
</div>

<div class="summary" id="summary"></div>
<div id="methods-container"></div>

<script>
const $ = id => document.getElementById(id);

function signedPct(v, d=2) { if (v == null) return '‚Äî'; return `${v >= 0 ? '+' : ''}${v.toFixed(d)}%`; }
function pctFmt(v) { if (v == null) return '‚Äî'; return (v * 100).toFixed(1) + '%'; }
function kv(k, v) { return `<div class="kv"><span class="kv-label">${k}</span><span class="kv-value">${v}</span></div>`; }

function gradeFor(gp) {
  if (gp >= 11) return ['A', 'grade-a'];
  if (gp >= 9) return ['B', 'grade-b'];
  return ['C', 'grade-c'];
}

async function loadData() {
  try {
    const r = await fetch('data/results.json?t=' + Date.now());
    return await r.json();
  } catch(e) { return null; }
}

function renderSummary(data) {
  const methods = data.methods || {};
  const methodNames = Object.keys(methods);
  let totalVariants = 0, totalValidated = 0, bestSortino = null, bestEV = null;

  methodNames.forEach(mn => {
    methods[mn].forEach(v => {
      totalVariants++;
      const cur = v.current || {};
      if (cur.all_11_passed) totalValidated++;
      const met = cur.metrics || {};
      if (met.sortino != null && (!bestSortino || met.sortino > bestSortino.val))
        bestSortino = { val: met.sortino, label: `${mn} (${v.db_name})` };
      if (met.avg_pnl != null && (!bestEV || met.avg_pnl > bestEV.val))
        bestEV = { val: met.avg_pnl, label: `${mn} (${v.db_name})` };
    });
  });

  $('summary').innerHTML = `
    <div class="summary-card"><div class="summary-label">Methods</div>
      <div class="summary-value" style="color:var(--cyan)">${methodNames.length}</div>
      <div class="summary-sub">${totalVariants} variants</div></div>
    <div class="summary-card"><div class="summary-label">Validated</div>
      <div class="summary-value" style="color:${totalValidated > 0 ? 'var(--green)' : 'var(--red)'}">${totalValidated}</div>
      <div class="summary-sub">11/11 gates</div></div>
    <div class="summary-card"><div class="summary-label">Best Sortino</div>
      <div class="summary-value" style="color:var(--cyan)">${bestSortino ? bestSortino.val.toFixed(2) : '‚Äî'}</div>
      <div class="summary-sub">${bestSortino ? bestSortino.label : '‚Äî'}</div></div>
    <div class="summary-card"><div class="summary-label">Best EV</div>
      <div class="summary-value" style="color:var(--green)">${bestEV ? signedPct(bestEV.val, 2) : '‚Äî'}</div>
      <div class="summary-sub">${bestEV ? bestEV.label : '‚Äî'}</div></div>
  `;
}

function renderGates(gates) {
  if (!gates) return '';
  const order = ['SIG','EQ','WF','MC','PLT','REG','ROB','tT','DSR','WRC','HHI'];
  return order.map(g => {
    const p = gates[g];
    return `<span class="gate-pill ${p ? 'pass' : 'fail'}">${g}</span>`;
  }).join('');
}

function renderTrainTest(tt) {
  if (!tt || !tt.train_n) return '';
  const deg = tt.train_avg_pnl > 0 ? (1 - tt.test_avg_pnl / tt.train_avg_pnl) : 0;
  const degPct = Math.round(deg * 100);
  let degColor = 'var(--green)', degLabel = 'Consistent';
  if (deg > .5) { degColor = 'var(--red)'; degLabel = 'OVERFIT WARNING'; }
  else if (deg > .25) { degColor = 'var(--yellow)'; degLabel = 'Moderate degradation'; }

  return `<div class="train-test">
    <div class="tt-panel"><div class="tt-title" style="color:var(--cyan)">TRAIN (Discovery)</div>
      ${kv('Trades', tt.train_n)} ${kv('EV', signedPct(tt.train_avg_pnl, 3))}
      ${kv('WR', pctFmt(tt.train_win_rate))}
      ${tt.train_period ? `<div style="font-size:.55rem;color:var(--text-muted);margin-top:.2rem">${tt.train_period}</div>` : ''}
    </div>
    <div class="tt-panel"><div class="tt-title" style="color:var(--green)">TEST (Validation)</div>
      ${kv('Trades', tt.test_n)} ${kv('EV', signedPct(tt.test_avg_pnl, 3))}
      ${kv('WR', pctFmt(tt.test_win_rate))}
      ${tt.test_period ? `<div style="font-size:.55rem;color:var(--text-muted);margin-top:.2rem">${tt.test_period}</div>` : ''}
    </div>
  </div>
  <div class="overfit-bar" style="background:${deg > .25 ? 'rgba(239,68,68,.1)' : 'rgba(34,197,94,.1)'}">
    <span style="color:${degColor};font-weight:600">${degLabel}</span>
    <span style="color:var(--text-muted);margin-left:.5rem">${degPct > 0 ? '-' : '+'}${Math.abs(degPct)}%</span>
  </div>`;
}

function renderLift(lift) {
  if (!lift) return '';
  const dims = [{key:'mcap',label:'MCAP'},{key:'time',label:'Time‚ÜíEntry'},{key:'dd',label:'DD@Entry'}];
  let hasAny = false;
  dims.forEach(d => { if (lift[d.key] && Object.keys(lift[d.key]).length) hasAny = true; });
  if (!hasAny) return '';
  let html = '<div class="filter-section"><div class="filter-title">üìà Pre-Entry LIFT</div>';
  dims.forEach(d => {
    const data = lift[d.key];
    if (!data || !Object.keys(data).length) return;
    html += `<div class="filter-cat">${d.label}</div>`;
    Object.entries(data).forEach(([k, v]) => {
      const w = Math.min(100, (v.lift || 0) * 40);
      html += `<div class="bar-row"><span class="bar-label">${k}</span>
        <div class="bar-bg"><div class="bar-fill ${v.good ? 'good' : 'bad'}" style="width:${w}%"></div></div>
        <span class="bar-val" style="color:${v.good ? 'var(--green)' : 'var(--red)'}">${(v.lift||0).toFixed(2)}</span>
        <span style="width:25px;font-size:.55rem;color:var(--text-muted)">n=${v.count||0}</span></div>`;
    });
  });
  return html + '</div>';
}

function renderPostEntry(pf) {
  if (!pf || !Object.keys(pf).length) return '';
  let hasExits = false;
  Object.values(pf).forEach(bs => { Object.values(bs).forEach(b => { if (!b.keep) hasExits = true; }); });
  if (!hasExits) return '';
  let html = '<div class="filter-section"><div class="filter-title">üîç Post-Entry Filters</div>';
  Object.entries(pf).forEach(([cat, buckets]) => {
    const exits = Object.entries(buckets).filter(([,b]) => !b.keep);
    if (!exits.length) return;
    html += `<div class="filter-cat" style="color:var(--magenta)">${cat}</div>`;
    Object.entries(buckets).forEach(([suffix, b]) => {
      const w = Math.min(100, (b.lift||0) * 40);
      const isKeep = b.keep;
      html += `<div class="bar-row"><span class="bar-label" style="width:100px">${suffix}</span>
        <div class="bar-bg"><div class="bar-fill ${isKeep ? 'good' : 'bad'}" style="width:${w}%"></div></div>
        <span class="bar-tag" style="color:${isKeep ? 'var(--green)' : 'var(--red)'}">${isKeep ? 'KEEP' : 'EXIT'}</span>
        <span class="bar-val" style="color:${isKeep ? 'var(--green)' : 'var(--red)'}">${(b.lift||0).toFixed(2)}</span>
        <span style="width:25px;font-size:.55rem;color:var(--text-muted)">n=${b.count||0}</span></div>`;
    });
  });
  return html + '</div>';
}

function renderEnv(envBlock, uid) {
  if (!envBlock) return '';
  const highlighted = envBlock
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/(#[^\n]*)/g, '<span class="comment">$1</span>');
  return `<div class="env-block" id="${uid}">
    <button class="copy-btn" onclick="copyEnv('${uid}')">üìã Copy .env</button>
    ${highlighted}</div>`;
}

function copyEnv(uid) {
  const el = document.getElementById(uid);
  if (!el) return;
  const text = el.innerText.replace('üìã Copy .env', '').trim();
  navigator.clipboard.writeText(text).then(() => {
    const btn = el.querySelector('.copy-btn');
    if (btn) { btn.textContent = '‚úÖ Copied!'; setTimeout(() => btn.textContent = 'üìã Copy .env', 2000); }
  });
}

function renderVariantDetail(cur, variant) {
  if (!cur) return '<div style="color:var(--text-muted);padding:.5rem">No data</div>';
  const met = cur.metrics || {};
  const tt = cur.train_test || {};
  const gates = cur.gates || {};
  const gateValues = cur.gate_values || {};
  const lift = cur.lift_filters || {};
  const postEntry = cur.post_entry_filters || {};
  const envBlock = cur.env_block || '';
  const config = cur.config || {};
  const runMeta = cur._run_meta || {};
  const envUid = 'env-' + (variant.variant_key || Math.random().toString(36).substr(2,6));

  return `
    <div style="margin-bottom:.5rem">
      <div style="font-size:.6rem;color:var(--text-muted);margin-bottom:.5rem">
        DB: ${runMeta.db_name || variant.db_name || '?'} |
        Trades: ${(runMeta.total_trades || met.n_trades || 0).toLocaleString()} |
        Mints: ${runMeta.unique_mints || '?'} |
        Span: ${runMeta.time_span || '?'} |
        Flags: ${runMeta.flags || variant.flags || '?'}
      </div>
      <div style="margin-bottom:.3rem">${renderGates(gates)}</div>
      <div class="detail-grid">
        ${kv('Trades (TEST)', met.n_trades || 0)}
        ${kv('Win Rate', pctFmt(met.win_rate))}
        ${kv('EV/Trade', signedPct(met.avg_pnl, 3))}
        ${kv('Total PnL', signedPct(met.total_pnl, 1))}
        ${kv('Profit Factor', (met.profit_factor || 0).toFixed(3))}
        ${kv('Sortino', (met.sortino || 0).toFixed(3))}
        ${kv('Sharpe', (met.sharpe || 0).toFixed(3))}
        ${kv('Max DD', (met.max_dd || 0).toFixed(1) + '%')}
        ${kv('Risk of Ruin', (met.risk_of_ruin || 0).toFixed(1) + '%')}
        ${met.n_early_exits > 0 ? kv('Early Exits', met.n_early_exits) : ''}
        ${kv('SL / TP', (config.sl_pct || '?') + '% / ' + (config.tp_pct || '?') + '%')}
        ${config.has_trailing ? kv('Trailing', 'Act=' + config.trailing_activation_pct + '% Pct=' + config.trailing_pct + '%') : ''}
      </div>
    </div>
    ${renderTrainTest(tt)}
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.75rem;margin-top:.75rem">
      <div>${renderLift(lift)}</div>
      <div>${renderPostEntry(postEntry)}</div>
    </div>
    ${renderEnv(envBlock, envUid)}
    ${renderHistory(variant.history || [])}
    <div style="margin-top:.5rem">
      <div class="detail-grid">
        ${kv('Entries (raw)', cur.n_total_entries || 0)}
        ${kv('Entries (filtered)', cur.n_filtered_entries || 0)}
        ${cur.n_total_entries > 0 ? kv('Filter Rate',
          ((1 - (cur.n_filtered_entries || 0) / cur.n_total_entries) * 100).toFixed(1) + '% removed') : ''}
      </div>
    </div>
    <div style="font-size:.55rem;color:var(--text-muted);margin-top:.5rem;text-align:right">
      Gate details: ${Object.entries(gateValues).map(([g,v]) => g+'='+v).join(' | ')}
    </div>
  `;
}

function renderHistory(history) {
  if (!history || !history.length) return '';
  let html = '<div class="history"><div style="font-size:.65rem;color:var(--text-muted);font-weight:600;margin-bottom:.2rem">üìú Previous Runs</div>';
  history.forEach(h => {
    const [g, gc] = gradeFor(h.gates_passed || 0);
    html += `<div class="history-row">
      <span>${(h.timestamp || '?').substring(0, 16)}</span>
      <span class="grade ${gc}">${h.gates_passed}/11</span>
      <span style="color:${(h.avg_pnl||0) >= 0 ? 'var(--green)' : 'var(--red)'}">${signedPct(h.avg_pnl, 3)}</span>
      <span>Srt=${(h.sortino||0).toFixed(2)}</span>
      <span>n=${h.n_trades || '?'}</span>
    </div>`;
  });
  return html + '</div>';
}

function renderMethods(data) {
  const methods = data.methods || {};
  const container = $('methods-container');
  container.innerHTML = '';

  const sorted = Object.keys(methods).sort();
  if (!sorted.length) {
    container.innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:3rem">No backtest results yet. Run the pipeline to see data here.</div>';
    return;
  }

  sorted.forEach(mn => {
    const variants = methods[mn];
    // Best variant for this method
    let bestGP = 0, bestVariant = null;
    variants.forEach(v => {
      const gp = v.current?.gates_passed || 0;
      if (gp > bestGP) { bestGP = gp; bestVariant = v; }
    });

    const [grade, gradeClass] = gradeFor(bestGP);
    const hasValidated = variants.some(v => v.current?.all_11_passed);
    const badgeClass = hasValidated ? 'validated' : bestGP >= 9 ? 'partial' : 'none';
    const badgeText = hasValidated ? '‚úÖ VALIDATED' : `${bestGP}/11`;

    const folder = document.createElement('div');
    folder.className = 'method-folder';
    folder.innerHTML = `
      <div class="method-header" onclick="toggleFolder(this)">
        <div style="display:flex;align-items:center;gap:.75rem">
          <span class="chevron">‚ñ∂</span>
          <span class="method-name">üìÅ ${mn}</span>
          <span class="method-badge ${badgeClass}">${badgeText}</span>
          <span style="font-size:.65rem;color:var(--text-muted)">${variants.length} variant${variants.length !== 1 ? 's' : ''}</span>
        </div>
        <div style="display:flex;gap:1rem;font-family:var(--font-mono);font-size:.7rem">
          ${bestVariant ? `<span style="color:${(bestVariant.current?.metrics?.avg_pnl||0)>=0?'var(--green)':'var(--red)'}">EV=${signedPct(bestVariant.current?.metrics?.avg_pnl,2)}</span>
          <span style="color:var(--cyan)">Srt=${(bestVariant.current?.metrics?.sortino||0).toFixed(2)}</span>` : ''}
        </div>
      </div>
      <div class="method-body" id="body-${mn}">
        ${variants.map((v, i) => renderVariant(mn, v, i)).join('')}
      </div>
    `;
    container.appendChild(folder);
  });
}

function renderVariant(methodName, variant, idx) {
  const cur = variant.current || {};
  const met = cur.metrics || {};
  const gp = cur.gates_passed || 0;
  const [grade, gradeClass] = gradeFor(gp);
  const vid = `var-${methodName}-${idx}`;

  return `<div class="variant">
    <div class="variant-header" onclick="toggleVariant('${vid}')">
      <div style="display:flex;align-items:center;gap:.5rem">
        <span class="chevron" id="chev-${vid}">‚ñ∂</span>
        <span class="variant-tag">üìÑ ${variant.db_name || '?'}</span>
        <span style="font-size:.55rem;color:var(--text-muted)">${variant.flags || ''}</span>
      </div>
      <div class="variant-stats">
        <span class="grade ${gradeClass}">${gp}/11</span>
        <span style="color:${(met.avg_pnl||0)>=0?'var(--green)':'var(--red)'}">${signedPct(met.avg_pnl,2)}</span>
        <span style="color:var(--cyan)">Srt=${(met.sortino||0).toFixed(2)}</span>
        <span style="color:var(--text-muted)">n=${met.n_trades||0}</span>
        <span style="color:var(--text-muted)">√ó${variant.run_count || 1}</span>
        <span style="font-size:.55rem;color:var(--text-muted)">${(variant.updated_at || '').substring(0, 16)}</span>
      </div>
    </div>
    <div class="variant-detail" id="${vid}">
      ${renderVariantDetail(cur, variant)}
    </div>
  </div>`;
}

function toggleFolder(el) {
  const body = el.nextElementSibling;
  const chev = el.querySelector('.chevron');
  body.classList.toggle('open');
  chev.classList.toggle('open');
}

function toggleVariant(vid) {
  const detail = document.getElementById(vid);
  const chev = document.getElementById('chev-' + vid);
  detail.classList.toggle('open');
  if (chev) chev.classList.toggle('open');
}

async function init() {
  const data = await loadData();
  if (!data) { $('methods-container').innerHTML = '<p style="color:var(--red);padding:2rem">Failed to load data</p>'; return; }
  $('last-update').textContent = data.last_updated ? new Date(data.last_updated).toLocaleString('de-DE') : 'never';
  renderSummary(data);
  renderMethods(data);
}

init();
setInterval(init, 60000);
</script>
</body>
</html>
