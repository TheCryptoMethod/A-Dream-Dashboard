<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A_Dream ‚Äî Unified Dashboard V5</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg-primary: #0a0e17; --bg-secondary: #111827; --bg-card: #151d2e;
    --bg-card-hover: #1a2540; --border: #1e293b; --border-active: #334155;
    --text-primary: #e2e8f0; --text-secondary: #94a3b8; --text-muted: #64748b;
    --green: #22c55e; --green-dim: #166534; --green-glow: rgba(34,197,94,0.15);
    --red: #ef4444; --red-dim: #991b1b;
    --cyan: #06b6d4; --cyan-dim: #0e7490; --cyan-glow: rgba(6,182,212,0.1);
    --yellow: #eab308; --magenta: #d946ef;
    --font-mono: 'JetBrains Mono','Consolas',monospace;
    --font-display: 'Outfit',sans-serif;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg-primary); color:var(--text-primary); font-family:var(--font-display); min-height:100vh; }

  .header { background:linear-gradient(180deg,var(--bg-secondary),var(--bg-primary)); border-bottom:1px solid var(--border); padding:1.5rem 2rem; position:sticky; top:0; z-index:100; }
  .header-inner { max-width:1600px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
  .logo { display:flex; align-items:center; gap:.75rem; }
  .logo-icon { width:36px; height:36px; background:linear-gradient(135deg,var(--cyan),var(--magenta)); border-radius:8px; display:flex; align-items:center; justify-content:center; font-size:18px; font-weight:700; color:#fff; font-family:var(--font-mono); }
  .logo-text { font-size:1.25rem; font-weight:600; } .logo-text span { color:var(--cyan); }
  .header-stats { display:flex; gap:2rem; font-family:var(--font-mono); font-size:.8rem; color:var(--text-secondary); }
  .header-stat-value { color:var(--text-primary); font-weight:600; } .header-stat-value.green { color:var(--green); }

  .main { max-width:1600px; margin:0 auto; padding:1.5rem 2rem; }

  .summary-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-bottom:1.5rem; }
  .summary-card { background:var(--bg-card); border:1px solid var(--border); border-radius:10px; padding:1.25rem; }
  .summary-label { font-size:.7rem; text-transform:uppercase; letter-spacing:.1em; color:var(--text-muted); margin-bottom:.5rem; }
  .summary-value { font-family:var(--font-mono); font-size:1.75rem; font-weight:700; }
  .summary-sub { font-size:.75rem; color:var(--text-secondary); margin-top:.25rem; font-family:var(--font-mono); }

  .runs-section { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; overflow:hidden; }
  .runs-header { padding:1rem 1.25rem; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
  .runs-title { font-weight:600; font-size:.95rem; } .runs-count { font-family:var(--font-mono); font-size:.75rem; color:var(--text-muted); }

  .runs-table { width:100%; border-collapse:collapse; }
  .runs-table th { text-align:left; padding:.6rem 1rem; font-size:.65rem; text-transform:uppercase; letter-spacing:.1em; color:var(--text-muted); border-bottom:1px solid var(--border); font-weight:500; background:var(--bg-secondary); font-family:var(--font-mono); }
  .runs-table td { padding:.7rem 1rem; font-family:var(--font-mono); font-size:.78rem; border-bottom:1px solid rgba(30,41,59,.5); vertical-align:middle; }
  .runs-table tbody tr { cursor:pointer; transition:background .1s; } .runs-table tbody tr:hover { background:var(--bg-card-hover); }

  .gate-badge { display:inline-flex; width:22px; height:22px; border-radius:4px; align-items:center; justify-content:center; font-size:.55rem; font-weight:700; font-family:var(--font-mono); margin:0 1px; }
  .gate-pass { background:var(--green-dim); color:var(--green); } .gate-fail { background:var(--red-dim); color:var(--red); }

  .detail-row { display:none; } .detail-row.visible { display:table-row; }
  .detail-cell { padding:1.25rem !important; background:var(--bg-secondary) !important; border-bottom:2px solid var(--cyan-dim) !important; }
  .detail-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
  .detail-section { background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:1rem; }
  .detail-section-title { font-size:.7rem; text-transform:uppercase; letter-spacing:.1em; color:var(--cyan); margin-bottom:.75rem; font-weight:600; }
  .detail-kv { display:flex; justify-content:space-between; padding:.3rem 0; font-family:var(--font-mono); font-size:.75rem; border-bottom:1px solid rgba(30,41,59,.3); }
  .detail-kv:last-child { border-bottom:none; }
  .detail-key { color:var(--text-muted); } .detail-val { color:var(--text-primary); font-weight:500; }

  .env-block { background:#0d1117; border:1px solid var(--cyan-dim); border-radius:8px; padding:1rem; padding-top:2.5rem; font-family:var(--font-mono); font-size:.72rem; color:var(--cyan); white-space:pre-wrap; line-height:1.6; position:relative; margin-top:1rem; }
  .env-block .comment { color:var(--text-muted); }
  .copy-btn { position:absolute; top:.5rem; right:.5rem; background:var(--cyan-dim); color:var(--cyan); border:none; border-radius:6px; padding:.4rem .8rem; font-family:var(--font-mono); font-size:.7rem; cursor:pointer; font-weight:600; z-index:2; }
  .copy-btn:hover { background:var(--cyan); color:#000; }
  .copy-btn.copied { background:var(--green-dim); color:var(--green); }

  .method-tabs { display:flex; gap:2px; margin-bottom:1rem; background:var(--bg-secondary); border-radius:8px; overflow:hidden; border:1px solid var(--border); }
  .method-tab { padding:.5rem 1rem; font-family:var(--font-mono); font-size:.75rem; cursor:pointer; background:none; border:none; color:var(--text-muted); transition:all .15s; }
  .method-tab:hover { color:var(--text-primary); background:var(--bg-card); }
  .method-tab.active { color:var(--cyan); background:var(--bg-card); box-shadow:inset 0 -2px 0 var(--cyan); }

  .lift-bar { display:flex; align-items:center; gap:.5rem; padding:.25rem 0; font-family:var(--font-mono); font-size:.7rem; }
  .lift-label { width:65px; color:var(--text-muted); text-align:right; }
  .lift-fill-bg { flex:1; height:16px; background:rgba(30,41,59,.5); border-radius:3px; overflow:hidden; }
  .lift-fill { height:100%; border-radius:3px; transition:width .3s; }
  .lift-good { background:linear-gradient(90deg,var(--green-dim),var(--green)); }
  .lift-bad { background:linear-gradient(90deg,var(--red-dim),var(--red)); }
  .lift-val { width:40px; text-align:right; font-weight:600; }
  .lift-count { width:35px; text-align:right; color:var(--text-muted); font-size:.65rem; }

  .empty-state { text-align:center; padding:4rem 2rem; color:var(--text-muted); }
  .empty-icon { font-size:3rem; margin-bottom:1rem; opacity:.3; } .empty-text { font-size:1.1rem; color:var(--text-secondary); margin-bottom:.5rem; }
  .empty-sub { font-size:.85rem; font-family:var(--font-mono); }

  .grade { display:inline-flex; padding:.2rem .5rem; border-radius:4px; font-size:.7rem; font-weight:700; font-family:var(--font-mono); }
  .grade-a { background:var(--green-dim); color:var(--green); }
  .grade-b { background:rgba(234,179,8,.15); color:var(--yellow); }
  .grade-c { background:rgba(249,115,22,.15); color:var(--orange); }
  .grade-d { background:var(--red-dim); color:var(--red); }

  @media (max-width:1024px) { .detail-grid { grid-template-columns:1fr; } .main { padding:1rem; } .header-stats { display:none; } }
  @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
  ::-webkit-scrollbar { width:6px; } ::-webkit-scrollbar-track { background:var(--bg-primary); } ::-webkit-scrollbar-thumb { background:var(--border-active); border-radius:3px; }
</style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo"><div class="logo-icon">A</div><div class="logo-text">A_Dream <span>Dashboard V5</span></div></div>
    <div class="header-stats">
      <div>Runs: <span class="header-stat-value" id="h-runs">0</span></div>
      <div>Validated: <span class="header-stat-value green" id="h-validated">0</span></div>
      <div>Last: <span class="header-stat-value" id="h-last">‚Äî</span></div>
    </div>
  </div>
</header>

<div class="main">
  <div class="summary-row">
    <div class="summary-card"><div class="summary-label">Total Runs</div><div class="summary-value" id="s-runs">0</div></div>
    <div class="summary-card"><div class="summary-label">Methods Validated</div><div class="summary-value" style="color:var(--green)" id="s-validated">0</div></div>
    <div class="summary-card"><div class="summary-label">Best Sortino</div><div class="summary-value" style="color:var(--cyan)" id="s-sortino">‚Äî</div><div class="summary-sub" id="s-sortino-sub">‚Äî</div></div>
    <div class="summary-card"><div class="summary-label">Best EV/Trade</div><div class="summary-value" style="color:var(--yellow)" id="s-ev">‚Äî</div><div class="summary-sub" id="s-ev-sub">‚Äî</div></div>
  </div>

  <div class="runs-section">
    <div class="runs-header"><div class="runs-title">Backtest Runs ‚Äî Unified Pipeline</div><div class="runs-count" id="runs-count">0 runs</div></div>
    <div style="overflow-x:auto">
      <table class="runs-table" id="runs-table">
        <thead><tr>
          <th>Date</th><th>Methods</th><th>DB</th><th>Trades</th><th>Mints</th>
          <th>Best Method</th><th>Gates</th><th>EV (TEST)</th><th>Sortino</th><th>Grade</th>
        </tr></thead>
        <tbody id="runs-body"></tbody>
      </table>
    </div>
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">üìä</div>
      <div class="empty-text">No backtest runs yet</div>
      <div class="empty-sub" style="margin-top:.75rem">Run: <span style="color:var(--cyan)">bt --M1 --M2 --M3 --M4</span></div>
      <div class="empty-sub">or: <span style="color:var(--cyan)">bt</span> (all methods)</div>
    </div>
  </div>
</div>

<script>
const GATE_NAMES = ['SIG','EQ','WF','MC','PLT','REG','ROB','tT','DSR','WRC','HHI'];
let allRuns = [];

async function loadData() {
  try {
    const resp = await fetch('data/results.json?t=' + Date.now());
    const data = await resp.json();
    allRuns = data.runs || [];
    allRuns.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
    renderAll();
  } catch(e) { console.error('Load error:', e); renderAll(); }
}

function renderAll() {
  const $ = id => document.getElementById(id);
  $('s-runs').textContent = allRuns.length;
  $('runs-count').textContent = `${allRuns.length} run${allRuns.length !== 1 ? 's' : ''}`;
  $('empty-state').style.display = allRuns.length ? 'none' : 'block';
  $('h-runs').textContent = allRuns.length;

  let totalValidated = 0, bestSortino = null, bestEV = null;

  allRuns.forEach(run => {
    const pa = run.passed_all || 0;
    totalValidated += pa;
    const b = run.best || {};
    if (b.sortino != null && (!bestSortino || b.sortino > bestSortino.val))
      bestSortino = { val: b.sortino, label: b.method || '' };
    if (b.avg_pnl != null && (!bestEV || b.avg_pnl > bestEV.val))
      bestEV = { val: b.avg_pnl, label: b.method || '' };
  });

  $('s-validated').textContent = totalValidated;
  $('h-validated').textContent = totalValidated;
  if (bestSortino) { $('s-sortino').textContent = bestSortino.val.toFixed(2); $('s-sortino-sub').textContent = bestSortino.label; }
  if (bestEV) { $('s-ev').textContent = `${bestEV.val >= 0 ? '+' : ''}${bestEV.val.toFixed(2)}%`; $('s-ev-sub').textContent = bestEV.label; }
  if (allRuns.length) $('h-last').textContent = fmtDate(allRuns[0].timestamp);

  const tbody = document.getElementById('runs-body');
  tbody.innerHTML = '';

  allRuns.forEach((run, idx) => {
    const b = run.best || {};
    const methods = run.methods ? run.methods.map(m => m.method).join(', ') : (run.method || '‚Äî');
    const gp = b.gates_passed || 0;
    const grade = gp === 11 ? 'A' : gp >= 9 ? 'B' : gp >= 7 ? 'C' : 'D';
    const gradeClass = grade === 'A' ? 'grade-a' : grade === 'B' ? 'grade-b' : grade === 'C' ? 'grade-c' : 'grade-d';

    const tr = document.createElement('tr');
    tr.style.animation = `fadeIn .25s ease ${idx * .03}s forwards`;
    tr.style.opacity = '0';
    tr.innerHTML = `
      <td style="color:var(--text-secondary)">${fmtDate(run.timestamp)}</td>
      <td style="color:var(--cyan);font-weight:600">${methods}${run.version ? ` <span style="font-size:.55rem;color:var(--text-muted)">${run.version}</span>` : ''}</td>
      <td style="color:var(--text-muted)" title="${run.db_name || ''}">${trunc(run.db_name || '‚Äî', 20)}</td>
      <td>${(run.total_trades || 0).toLocaleString()}</td>
      <td style="color:var(--text-muted)">${run.unique_mints || '‚Äî'}</td>
      <td style="font-weight:600">${b.method || '‚Äî'}</td>
      <td>${renderGateMini(b.gates || {}, gp)}</td>
      <td style="color:${(b.avg_pnl || 0) >= 0 ? 'var(--green)' : 'var(--red)'}">
        ${b.avg_pnl != null ? `${b.avg_pnl >= 0 ? '+' : ''}${b.avg_pnl.toFixed(2)}%` : '‚Äî'}</td>
      <td style="color:var(--cyan)">${b.sortino != null ? b.sortino.toFixed(2) : '‚Äî'}</td>
      <td><span class="grade ${gradeClass}">${grade} (${gp}/11)</span></td>
    `;
    tr.addEventListener('click', () => toggleDetail(run, tr));
    tbody.appendChild(tr);
  });
}

function renderGateMini(gates, gp) {
  return GATE_NAMES.map(g => {
    const p = gates[g];
    if (p === undefined) return `<span class="gate-badge" style="background:var(--bg-secondary);color:var(--text-muted)">?</span>`;
    return `<span class="gate-badge ${p ? 'gate-pass' : 'gate-fail'}" title="${g}">${g.substring(0, 2)}</span>`;
  }).join('');
}

function toggleDetail(run, tr) {
  const existing = tr.nextElementSibling;
  if (existing && existing.classList.contains('detail-row')) { existing.remove(); return; }
  document.querySelectorAll('.detail-row').forEach(el => el.remove());

  const methods = run.methods || [];
  const dtr = document.createElement('tr');
  dtr.className = 'detail-row visible';
  
  if (methods.length > 0) {
    dtr.innerHTML = `<td class="detail-cell" colspan="10">
      <div class="method-tabs" id="mtabs-${run.timestamp.replace(/[:.]/g,'')}">
        ${methods.map((m, i) => {
          const col = m.all_11_passed ? 'color:var(--green)' : m.gates_passed >= 9 ? 'color:var(--yellow)' : '';
          return `<button class="method-tab${i === 0 ? ' active' : ''}" style="${col}" data-midx="${i}">${m.method} (${m.gates_passed}/11)</button>`;
        }).join('')}
      </div>
      <div class="method-content"></div>
    </td>`;
    tr.after(dtr);
    
    // Store data and render first tab
    dtr._methods = methods;
    renderMethodContent(dtr, 0);
    
    // Tab clicks
    dtr.querySelectorAll('.method-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.stopPropagation();
        dtr.querySelectorAll('.method-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        renderMethodContent(dtr, parseInt(tab.dataset.midx));
      });
    });
  } else {
    // Legacy V1 run
    const b = run.best || {};
    dtr.innerHTML = `<td class="detail-cell" colspan="10">
      <div class="detail-section">
        <div class="detail-section-title">Legacy Run</div>
        ${kv('SL/TP', `${b.sl || '?'}% / ${b.tp || '?'}%`)}
        ${kv('EV', `${(b.avg_pnl || 0).toFixed(3)}%`)}
        ${kv('Win Rate', `${((b.win_rate || 0) * 100).toFixed(1)}%`)}
      </div>
    </td>`;
    tr.after(dtr);
  }
}

function renderMethodContent(dtr, idx) {
  const m = dtr._methods[idx];
  const container = dtr.querySelector('.method-content');
  if (!m) { container.innerHTML = ''; return; }
  
  const met = m.metrics || {};
  const cfg = m.config || {};
  const gates = m.gates || {};
  const gv = m.gate_values || {};
  const lift = m.lift_filters || {};
  const ep = cfg.entry_params || {};
  
  container.innerHTML = `
    <div class="detail-grid">
      <!-- LEFT: Validation + Gates -->
      <div>
        <div class="detail-section">
          <div class="detail-section-title">üìä Validation ‚Äî ${m.method}</div>
          ${kv('Status', m.all_11_passed ? '<span style="color:var(--green)">‚úÖ VALIDATED (on TEST)</span>' : `<span style="color:var(--yellow)">‚ö† ${m.gates_passed}/11 gates</span>`)}
          ${kv('Trades', (met.n_trades || 0).toLocaleString())}
          ${kv('Win Rate', pctFmt(met.win_rate))}
          ${kv('EV/Trade', signedPct(met.avg_pnl, 3))}
          ${kv('Total PnL', signedPct(met.total_pnl, 1))}
          ${kv('Profit Factor', (met.profit_factor || 0).toFixed(3))}
          ${kv('Sortino', (met.sortino || 0).toFixed(3))}
          ${kv('Sharpe', (met.sharpe || 0).toFixed(3))}
          ${kv('Max Drawdown', (met.max_dd || 0).toFixed(1) + '%')}
          ${kv('Risk of Ruin', (met.risk_of_ruin || 0).toFixed(1) + '%')}
          ${met.n_early_exits > 0 ? kv('Early Exits', met.n_early_exits + ' post-entry') : ''}
        </div>
        ${renderTrainTest(m.train_test || {})}
        <div class="detail-section" style="margin-top:1rem">
          <div class="detail-section-title">üîí 11 Gates Detail</div>
          ${GATE_NAMES.map(g => `
            <div style="display:flex;align-items:center;gap:.5rem;padding:.25rem 0;font-family:var(--font-mono);font-size:.72rem;border-bottom:1px solid rgba(30,41,59,.3)">
              <span style="width:35px;color:var(--text-muted);font-weight:600">${g}</span>
              <span class="gate-badge ${gates[g] ? 'gate-pass' : 'gate-fail'}" style="flex-shrink:0">${gates[g] ? '‚úì' : '‚úó'}</span>
              <span style="color:var(--text-secondary);font-size:.65rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${gv[g] || '‚Äî'}</span>
            </div>
          `).join('')}
        </div>
      </div>
      <!-- RIGHT: Config + LIFT -->
      <div>
        <div class="detail-section">
          <div class="detail-section-title">‚öôÔ∏è Strategy Config</div>
          ${kv('Method', cfg.method || m.method)}
          ${ep.fib_ratio != null ? kv('Fib Ratio', ep.fib_ratio) : ''}
          ${ep.reversal_pct != null ? kv('Reversal %', ep.reversal_pct + '%') : ''}
          ${ep.drop1_fib != null ? kv('Drop1 Fib', ep.drop1_fib) : ''}
          ${ep.rev1_ratio != null ? kv('Rev1 Ratio', ep.rev1_ratio) : ''}
          ${ep.drop2_fib != null ? kv('Drop2 Fib', ep.drop2_fib) : ''}
          <div style="margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)"></div>
          ${kv('SL', cfg.sl_pct + '%')}
          ${kv('TP', cfg.tp_pct + '%')}
          ${cfg.has_trailing ? kv('Trailing Activation', '+' + cfg.trailing_activation_pct + '%') : kv('Trailing', 'OFF')}
          ${cfg.has_trailing ? kv('Trailing Stop', cfg.trailing_pct + '% below high') : ''}
          <div style="margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)"></div>
          <div style="font-size:.65rem;color:var(--text-muted);margin-bottom:.3rem;text-transform:uppercase">Pre-Entry Filters</div>
          ${kv('MCAP Range', '$' + fmtK(cfg.mcap_min) + ' ‚Äî $' + fmtK(cfg.mcap_max))}
          ${cfg.time_to_entry_min_ms > 0 || cfg.time_to_entry_max_ms < 86400000 ? kv('Time‚ÜíEntry', fmtMs(cfg.time_to_entry_min_ms) + ' ‚Äî ' + fmtMs(cfg.time_to_entry_max_ms)) : ''}
          ${cfg.dd_at_entry_min > 0 || cfg.dd_at_entry_max < 100 ? kv('DD@Entry', cfg.dd_at_entry_min + '% ‚Äî ' + cfg.dd_at_entry_max + '%') : ''}
          <div style="margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)"></div>
          ${kv('Entries (raw)', m.n_total_entries)}
          ${kv('Entries (filtered)', m.n_filtered_entries)}
          ${kv('Filter Rate', m.n_total_entries > 0 ? ((1 - m.n_filtered_entries / m.n_total_entries) * 100).toFixed(1) + '% removed' : '‚Äî')}
        </div>
        ${renderLift(lift)}
        ${renderPostEntry(m.post_entry_filters || {})}
      </div>
    </div>
    ${m.env_block ? renderEnv(m.env_block, m.method) : ''}
  `;
}

function renderLift(lift) {
  if (!lift) return '';
  const dims = [
    { key: 'mcap', label: 'MCAP Buckets' },
    { key: 'time', label: 'Time‚ÜíEntry' },
    { key: 'dd', label: 'DD@Entry' }
  ];
  
  let hasAny = false;
  dims.forEach(d => { if (lift[d.key] && Object.keys(lift[d.key]).length) hasAny = true; });
  if (!hasAny) return '';
  
  let html = '<div class="detail-section" style="margin-top:1rem"><div class="detail-section-title">üìà LIFT Analysis</div>';
  html += '<div style="font-size:.6rem;color:var(--text-muted);margin-bottom:.75rem">LIFT > 0.8 = good bucket (winners overrepresented). Used for pre-entry filtering.</div>';
  
  dims.forEach(d => {
    const data = lift[d.key];
    if (!data || !Object.keys(data).length) return;
    
    html += `<div style="font-size:.65rem;color:var(--cyan);margin-top:.75rem;margin-bottom:.25rem;font-weight:600">${d.label}</div>`;
    Object.entries(data).forEach(([k, v]) => {
      const liftVal = v.lift || 0;
      const w = Math.min(100, liftVal * 40);
      const cls = v.good ? 'lift-good' : 'lift-bad';
      const color = v.good ? 'var(--green)' : 'var(--red)';
      html += `<div class="lift-bar">
        <span class="lift-label">${k}</span>
        <div class="lift-fill-bg"><div class="lift-fill ${cls}" style="width:${w}%"></div></div>
        <span class="lift-val" style="color:${color}">${liftVal.toFixed(2)}</span>
        <span class="lift-count">n=${v.count || 0}</span>
      </div>`;
    });
  });
  
  return html + '</div>';
}

function renderTrainTest(tt) {
  if (!tt || !tt.train_n) return '';
  
  const degradation = tt.train_avg_pnl > 0 
    ? (1 - tt.test_avg_pnl / tt.train_avg_pnl) 
    : 0;
  const degPct = Math.round(degradation * 100);
  let degColor = 'var(--green)';
  let degLabel = 'Consistent';
  if (degradation > 0.50) { degColor = 'var(--red)'; degLabel = 'OVERFIT WARNING'; }
  else if (degradation > 0.25) { degColor = 'var(--yellow)'; degLabel = 'Moderate degradation'; }
  
  return `<div class="detail-section" style="margin-top:1rem">
    <div class="detail-section-title">üîÄ Train/Test Split (60/40)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:.5rem">
      <div style="background:rgba(6,182,212,0.08);border-radius:6px;padding:.5rem">
        <div style="font-size:.6rem;color:var(--cyan);text-transform:uppercase;margin-bottom:.25rem;font-weight:600">TRAIN (Discovery)</div>
        <div style="font-family:var(--font-mono);font-size:.75rem">
          ${kv('Trades', tt.train_n)}
          ${kv('EV/Trade', signedPct(tt.train_avg_pnl, 3))}
          ${kv('Win Rate', pctFmt(tt.train_win_rate))}
          ${tt.train_period ? kv('Period', tt.train_period) : ''}
        </div>
      </div>
      <div style="background:rgba(34,197,94,0.08);border-radius:6px;padding:.5rem">
        <div style="font-size:.6rem;color:var(--green);text-transform:uppercase;margin-bottom:.25rem;font-weight:600">TEST (Validation)</div>
        <div style="font-family:var(--font-mono);font-size:.75rem">
          ${kv('Trades', tt.test_n)}
          ${kv('EV/Trade', signedPct(tt.test_avg_pnl, 3))}
          ${kv('Win Rate', pctFmt(tt.test_win_rate))}
          ${tt.test_period ? kv('Period', tt.test_period) : ''}
        </div>
      </div>
    </div>
    <div style="font-family:var(--font-mono);font-size:.7rem;padding:.3rem .5rem;border-radius:4px;background:${degradation > 0.25 ? 'rgba(239,68,68,0.1)' : 'rgba(34,197,94,0.1)'}">
      <span style="color:${degColor};font-weight:600">${degLabel}</span>
      <span style="color:var(--text-muted);margin-left:.5rem">TRAIN‚ÜíTEST: ${degPct > 0 ? '-' : '+'}${Math.abs(degPct)}% degradation</span>
    </div>
  </div>`;
}

function renderPostEntry(postFilters) {
  if (!postFilters || !Object.keys(postFilters).length) return '';
  
  // Check if there are any EXIT buckets
  let hasExits = false;
  Object.values(postFilters).forEach(buckets => {
    Object.values(buckets).forEach(b => { if (!b.keep) hasExits = true; });
  });
  if (!hasExits) return '';
  
  let html = '<div class="detail-section" style="margin-top:1rem"><div class="detail-section-title">üîç Post-Entry Filters (Early Exit Gates)</div>';
  html += '<div style="font-size:.6rem;color:var(--text-muted);margin-bottom:.75rem">EXIT buckets trigger immediate sell at snapshot price</div>';
  
  Object.entries(postFilters).forEach(([category, buckets]) => {
    if (!Object.keys(buckets).length) return;
    const catExits = Object.values(buckets).some(b => !b.keep);
    if (!catExits) return;
    
    html += `<div style="font-size:.65rem;color:var(--magenta);margin-top:.75rem;margin-bottom:.25rem;font-weight:600">${category}</div>`;
    Object.entries(buckets).forEach(([suffix, b]) => {
      const liftVal = b.lift || 0;
      const w = Math.min(100, liftVal * 40);
      const isKeep = b.keep;
      const cls = isKeep ? 'lift-good' : 'lift-bad';
      const labelColor = isKeep ? 'var(--green)' : 'var(--red)';
      const label = isKeep ? 'KEEP' : 'EXIT';
      
      html += `<div class="lift-bar">
        <span class="lift-label" style="width:110px">${suffix}</span>
        <div class="lift-fill-bg"><div class="lift-fill ${cls}" style="width:${w}%"></div></div>
        <span style="width:35px;text-align:center;font-size:.6rem;font-weight:700;color:${labelColor};font-family:var(--font-mono)">${label}</span>
        <span class="lift-val" style="color:${isKeep ? 'var(--green)' : 'var(--red)'}">${liftVal.toFixed(2)}</span>
        <span class="lift-count">n=${b.count || 0}</span>
      </div>`;
    });
  });
  
  return html + '</div>';
}

function renderEnv(envBlock, method) {
  const uid = 'env-' + method + '-' + Math.random().toString(36).substr(2, 6);
  const highlighted = envBlock
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
    .replace(/(#[^\n]*)/g, '<span class="comment">$1</span>');
  
  return `<div class="env-block" id="${uid}">
    <button class="copy-btn" onclick="copyEnv(this, '${uid}')">üìã Copy .env</button>
    ${highlighted}
  </div>`;
}

function copyEnv(btn, uid) {
  const el = document.getElementById(uid);
  // Get raw text without HTML
  const text = el.innerText.replace('üìã Copy .env', '').replace('‚úÖ Copied!', '').trim();
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = '‚úÖ Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'üìã Copy .env'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    document.body.removeChild(ta);
    btn.textContent = '‚úÖ Copied!';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'üìã Copy .env'; btn.classList.remove('copied'); }, 2000);
  });
}

// Helpers
function kv(k, v) { return `<div class="detail-kv"><span class="detail-key">${k}</span><span class="detail-val">${v ?? '‚Äî'}</span></div>`; }
function pctFmt(v) { return v != null ? (v * 100).toFixed(1) + '%' : '‚Äî'; }
function signedPct(v, d) { if (v == null) return '‚Äî'; return `${v >= 0 ? '+' : ''}${v.toFixed(d || 2)}%`; }
function fmtK(v) { if (v == null) return '?'; if (v >= 1e6) return (v/1e6).toFixed(0) + 'M'; return (v/1000).toFixed(0) + 'k'; }
function fmtMs(ms) { if (ms == null) return '?'; if (ms < 60000) return (ms/1000).toFixed(0) + 's'; if (ms < 3600000) return (ms/60000).toFixed(0) + 'm'; return (ms/3600000).toFixed(1) + 'h'; }
function fmtDate(ts) { if (!ts) return '‚Äî'; const d = new Date(ts); return d.toLocaleDateString('de-DE', {day:'2-digit', month:'2-digit', year:'2-digit'}) + ' ' + d.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}); }
function trunc(s, n) { return s && s.length > n ? s.substring(0, n) + '‚Ä¶' : (s || '‚Äî'); }

loadData();
setInterval(loadData, 60000);
</script>
</body>
</html>
